{% extends 'base.html' %}
{% load widget_tweaks %}
{% load static %}

{% block title %}สมัครสมาชิก - KATHAI{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow">
                <div class="card-header bg-warning text-dark text-center">
                    <h4><i class="bi bi-person-plus"></i> สมัครสมาชิก KATHAI</h4>
                </div>
                <div class="card-body">
                    

                    {# Display non-field errors at the top #}
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger" role="alert">
                            {{ form.non_field_errors }}
                        </div>
                    {% endif %}

                    <form method="post" novalidate>
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.first_name.id_for_label }}" class="form-label">{{ form.first_name.label }} <span class="text-danger">*</span></label>
                                    {{ form.first_name|add_class:"form-control" }}
                                    {% if form.first_name.errors %}
                                        <div class="text-danger small mt-1">{{ form.first_name.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.last_name.id_for_label }}" class="form-label">{{ form.last_name.label }} <span class="text-danger">*</span></label>
                                    {{ form.last_name|add_class:"form-control" }}
                                    {% if form.last_name.errors %}
                                        <div class="text-danger small mt-1">{{ form.last_name.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.email.id_for_label }}" class="form-label">{{ form.email.label }} <span class="text-danger">*</span></label>
                            {{ form.email|add_class:"form-control" }}
                            {% if form.email.errors %}
                                <div class="text-danger small mt-1">{{ form.email.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.phone_number.id_for_label }}" class="form-label">{{ form.phone_number.label }} <span class="text-danger">*</span></label>
                            {{ form.phone_number|add_class:"form-control"|attr:"placeholder:0812345678" }}
                            {% if form.phone_number.errors %}
                                <div class="text-danger small mt-1">{{ form.phone_number.errors }}</div>
                            {% endif %}
                            <div class="form-text text-muted">{{ form.phone_number.help_text }}</div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.username.id_for_label }}" class="form-label">{{ form.username.label }} <span class="text-danger">*</span></label>
                            {{ form.username|add_class:"form-control" }}
                            {% if form.username.errors %}
                                <div class="text-danger small mt-1">{{ form.username.errors }}</div>
                            {% endif %}
                            <div class="form-text text-muted">ใช้ได้เฉพาะตัวอักษร ตัวเลข และ @/./+/-/_ เท่านั้น</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.password1.id_for_label }}" class="form-label">รหัสผ่าน <span class="text-danger">*</span></label>
                            <div class="position-relative">
                                {{ form.password1|add_class:"form-control pe-5" }}
                                <button type="button" class="btn position-absolute end-0 top-0 h-100 px-3 border-0 bg-transparent" id="togglePassword1" style="z-index: 5;">
                                    <i class="bi bi-eye text-muted" id="eyeIcon1"></i>
                                </button>
                            </div>
                            {% if form.password1.errors %}
                                <div class="text-danger small mt-1">{{ form.password1.errors }}</div>
                            {% endif %}
                            {# Also show password2 errors here if they're password-related #}
                            {% if form.password2.errors and 'password' in form.password2.errors.0|lower %}
                                <div class="text-danger small mt-1">{{ form.password2.errors }}</div>
                            {% endif %}
                            <ul class="form-text ps-3" id="password-requirements">
                                <li id="length-req" class="text-muted">
                                    <i class="bi bi-circle me-1"></i>
                                    <span>ความยาวอย่างน้อย 8 ตัวอักษร</span>
                                </li>
                                <li id="case-req" class="text-muted">
                                    <i class="bi bi-circle me-1"></i>
                                    <span>มีทั้งตัวอักษรพิมพ์ใหญ่ และพิมพ์เล็ก</span>
                                </li>
                                <li id="special-req" class="text-muted">
                                    <i class="bi bi-circle me-1"></i>
                                    <span>ประกอบด้วยตัวตัวเลข หรืออักขระพิเศษ (เช่น ! @ # $ % ^ & *)</span>
                                </li>
                            </ul>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.password2.id_for_label }}" class="form-label">ยืนยันรหัสผ่าน <span class="text-danger">*</span></label>
                            <div class="position-relative">
                                {{ form.password2|add_class:"form-control pe-5" }}
                                <button type="button" class="btn position-absolute end-0 top-0 h-100 px-3 border-0 bg-transparent" id="togglePassword2" style="z-index: 5;">
                                    <i class="bi bi-eye text-muted" id="eyeIcon2"></i>
                                </button>
                            </div>
                            {# Always show password2 errors here #}
                            {% if form.password2.errors %}
                                <div class="text-danger small mt-1">{{ form.password2.errors }}</div>
                            {% endif %}
                        </div>

                        {# แก้ไขส่วนนี้: ใช้ {{ form.terms_accepted }} โดยตรง #}
                        <div class="form-check mb-3">
                            {{ form.terms_accepted|add_class:"form-check-input" }}
                            <label class="form-check-label small" for="{{ form.terms_accepted.id_for_label }}">
                                คุณได้ยอมรับ <a href="{% url 'accounts:terms_and_conditions' %}" class="text-decoration-none">ข้อตกลงและเงื่อนไข</a> และ <a href="{% url 'accounts:privacy_policy' %}" class="text-decoration-none">นโยบายความคุ้มครองข้อมูลส่วนบุคคล</a> ของ <strong>KATHAI</strong>
                            </label>
                            {% if form.terms_accepted.errors %}
                                <div class="text-danger small mt-1">{{ form.terms_accepted.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <button type="submit" class="btn btn-kathai w-100 mb-3">
                            <i class="bi bi-person-check"></i> สมัครสมาชิก
                        </button>
                        
                        <div class="text-center">
                            <p class="mb-0">มีบัญชีอยู่แล้ว? <a href="{% url 'accounts:login' %}" class="text-decoration-none">เข้าสู่ระบบ</a></p>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get form fields
    const password1Field = document.getElementById('{{ form.password1.id_for_label }}');
    const password2Field = document.getElementById('{{ form.password2.id_for_label }}');
    const usernameField = document.getElementById('{{ form.username.id_for_label }}');
    const firstNameField = document.getElementById('{{ form.first_name.id_for_label }}'); // Added this line
    
    // Password toggle functionality
    const togglePassword1 = document.getElementById('togglePassword1');
    const togglePassword2 = document.getElementById('togglePassword2');
    const eyeIcon1 = document.getElementById('eyeIcon1');
    const eyeIcon2 = document.getElementById('eyeIcon2');
    
    // Toggle password visibility for password1
    togglePassword1.addEventListener('click', function() {
        const type = password1Field.getAttribute('type') === 'password' ? 'text' : 'password';
        password1Field.setAttribute('type', type);
        
        // Toggle eye icon
        if (type === 'text') {
            eyeIcon1.className = 'bi bi-eye-slash text-muted';
        } else {
            eyeIcon1.className = 'bi bi-eye text-muted';
        }
    });
    
    // Toggle password visibility for password2
    togglePassword2.addEventListener('click', function() {
        const type = password2Field.getAttribute('type') === 'password' ? 'text' : 'password';
        password2Field.setAttribute('type', type);
        
        // Toggle eye icon
        if (type === 'text') {
            eyeIcon2.className = 'bi bi-eye-slash text-muted';
        } else {
            eyeIcon2.className = 'bi bi-eye text-muted';
        }
    });
    
    // Check if password fields have errors - check for Django form errors specifically
    const password1Errors = {{ form.password1.errors|yesno:"true,false" }};
    const password2Errors = {{ form.password2.errors|yesno:"true,false" }};
    
    // Focus logic
    if (password1Errors || password2Errors) {
        // If there are password errors, focus on the appropriate password field
        setTimeout(function() {
            // Store current scroll position
            const currentScrollY = window.scrollY;
            
            if (password1Errors) {
                password1Field.focus();
            } else if (password2Errors) {
                password2Field.focus();
            }
            
            // Prevent any scroll that might occur from focus
            window.scrollTo(0, currentScrollY);
        }, 100);
        
        // Temporarily disable scrolling when there are errors
        const preventScroll = function(e) {
            e.preventDefault();
            e.stopPropagation();
            return false;
        };
        
        // Add scroll prevention listeners
        document.addEventListener('scroll', preventScroll, { passive: false });
        document.addEventListener('wheel', preventScroll, { passive: false });
        document.addEventListener('touchmove', preventScroll, { passive: false });
        document.addEventListener('keydown', function(e) {
            // Prevent arrow keys, page up/down, space, home, end from scrolling
            if ([32, 33, 34, 35, 36, 37, 38, 39, 40].indexOf(e.keyCode) > -1) {
                e.preventDefault();
            }
        }, { passive: false });
        
        // Remove scroll prevention after a short delay
        setTimeout(function() {
            document.removeEventListener('scroll', preventScroll, { passive: false });
            document.removeEventListener('wheel', preventScroll, { passive: false });
            document.removeEventListener('touchmove', preventScroll, { passive: false });
        }, 1000); // Remove after 1 second
        
    } else {
        // If no password errors, focus on the first text box (first_name)
        setTimeout(function() {
            const currentScrollY = window.scrollY;
            firstNameField.focus();
            // Prevent scroll from focus
            window.scrollTo(0, currentScrollY);
        }, 100);
    }

    // Password validation feedback
    function validatePassword() {
        const password = password1Field.value;
        
        // Get requirement elements
        const lengthReq = document.getElementById('length-req');
        const caseReq = document.getElementById('case-req');
        const specialReq = document.getElementById('special-req');
        
        // Check length requirement (at least 8 characters)
        if (password.length >= 8) {
            updateRequirement(lengthReq, true);
        } else {
            updateRequirement(lengthReq, false);
        }
        
        // Check case requirement (both uppercase and lowercase)
        const hasUppercase = /[A-Z]/.test(password);
        const hasLowercase = /[a-z]/.test(password);
        if (hasUppercase && hasLowercase) {
            updateRequirement(caseReq, true);
        } else {
            updateRequirement(caseReq, false);
        }
        
        // Check special character or number requirement
        const hasNumberOrSpecial = /[0-9!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);
        if (hasNumberOrSpecial) {
            updateRequirement(specialReq, true);
        } else {
            updateRequirement(specialReq, false);
        }
    }
    
    function updateRequirement(element, isValid) {
        const icon = element.querySelector('i');
        
        if (isValid) {
            // Valid - green with checkmark
            element.className = 'text-success';
            icon.className = 'bi bi-check-circle-fill me-1 fs-6';
        } else {
            // Invalid - red with X (only if password field has content)
            if (password1Field.value.length > 0) {
                element.className = 'text-danger';
                icon.className = 'bi bi-x-circle-fill me-1 fs-6';
            } else {
                // No content - neutral
                element.className = 'text-muted';
                icon.className = 'bi bi-circle me-1 fs-6';
            }
        }
    }
    
    // Add event listeners for real-time validation
    password1Field.addEventListener('input', validatePassword);
    password1Field.addEventListener('keyup', validatePassword);
    
    // Initial validation on page load (in case password field has value)
    validatePassword();
});
</script>
{% endblock %}