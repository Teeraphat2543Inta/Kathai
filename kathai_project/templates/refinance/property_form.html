{% extends 'base.html' %}
{% load widget_tweaks %}

{% block title %}ยื่นคำขอรีไฟแนนซ์ - KATHAI{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow">
                <div class="card-header bg-warning text-dark">
                    <h4 class="mb-0"><i class="bi bi-file-earmark-plus"></i> ยื่นคำขอรีไฟแนนซ์</h4>
                </div>
                <div class="card-body">
                    {% if form.property.queryset %}
                    <form method="post" id="refinanceApplicationForm">
                        {% csrf_token %}
                        
                        {# Hidden input to potentially store pre-selected loan product ID #}
                        <input type="hidden" id="preSelectedLoanProductId" name="preSelectedLoanProductId" value="">

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.property.id_for_label }}" class="form-label">เลือกทรัพย์สิน <span class="text-danger">*</span></label>
                                    {{ form.property|add_class:"form-control" }}
                                    {% if form.property.errors %}
                                        <div class="text-danger small">{{ form.property.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.loan_amount.id_for_label }}" class="form-label">จำนวนเงินกู้ที่ต้องการ (บาท) <span class="text-danger">*</span></label>
                                    {{ form.loan_amount|add_class:"form-control"|attr:"placeholder:เช่น 3000000" }}
                                    {% if form.loan_amount.errors %}
                                        <div class="text-danger small">{{ form.loan_amount.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.loan_term.id_for_label }}" class="form-label">ระยะเวลากู้ (ปี) <span class="text-danger">*</span></label>
                                    {{ form.loan_term|add_class:"form-control"|attr:"placeholder:เช่น 30" }}
                                    {% if form.loan_term.errors %}
                                        <div class="text-danger small">{{ form.loan_term.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.purpose.id_for_label }}" class="form-label">วัตถุประสงค์ <span class="text-danger">*</span></label>
                                    {{ form.purpose|add_class:"form-control" }}
                                    {% if form.purpose.errors %}
                                        <div class="text-danger small">{{ form.purpose.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        {# ส่วนสำหรับแสดงแพ็กเกจสินเชื่อที่เกี่ยวข้อง #}
                        <div class="mb-4">
                            <label class="form-label">เลือกแพ็กเกจสินเชื่อที่ต้องการยื่นคำขอ <span class="text-danger">*</span></label>
                            <div id="loanProductsContainer" class="row">
                                <div class="col-12">
                                    <div class="alert alert-info text-center">
                                        โปรดเลือกทรัพย์สินก่อน เพื่อแสดงแพ็กเกจสินเชื่อที่เกี่ยวข้อง
                                    </div>
                                </div>
                            </div>
                            {# Error message for selected_loan_product, assuming it's a single field now #}
                            {% comment %} 
                            ถ้าคุณเปลี่ยน `form.selected_banks` ใน `forms.py` เป็น `form.selected_loan_product` 
                            และให้เป็น `ModelChoiceField` หรือ `ChoiceField` ธรรมดา คุณจะสามารถแสดง error แบบนี้ได้ 
                            {% endcomment %}
                            {% if form.selected_loan_product.errors %}
                                <div class="text-danger small mt-2">{{ form.selected_loan_product.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'refinance:application_list' %}" class="btn btn-secondary me-md-2">
                                <i class="bi bi-arrow-left"></i> ย้อนกลับ
                            </a>
                            <button type="submit" class="btn btn-kathai">
                                <i class="bi bi-send"></i> ยื่นคำขอ
                            </button>
                        </div>
                    </form>
                    {% else %}
                    <div class="alert alert-warning text-center">
                        <i class="bi bi-exclamation-triangle" style="font-size: 3rem;"></i>
                        <h4 class="mt-3">คุณต้องเพิ่มข้อมูลทรัพย์สินก่อน</h4>
                        <p>เพื่อที่จะยื่นคำขอรีไฟแนนซ์ คุณต้องมีข้อมูลทรัพย์สินในระบบก่อน</p>
                        <a href="{% url 'refinance:property_add' %}" class="btn btn-kathai">
                            <i class="bi bi-plus"></i> เพิ่มทรัพย์สิน
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const propertySelect = document.getElementById('{{ form.property.id_for_label }}');
        const loanAmountInput = document.getElementById('{{ form.loan_amount.id_for_label }}');
        const loanTermInput = document.getElementById('{{ form.loan_term.id_for_label }}');
        const loanProductsContainer = document.getElementById('loanProductsContainer');
        const preSelectedLoanProductIdInput = document.getElementById('preSelectedLoanProductId');

        // ฟังก์ชันสำหรับดึง query parameter จาก URL
        function getQueryParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // อ่าน selectedProductId จาก localStorage หรือ URL query param
        let initialSelectedProductId = localStorage.getItem('selectedProductId');
        if (!initialSelectedProductId) {
            initialSelectedProductId = getQueryParam('loan_product_id');
        }
        if (initialSelectedProductId) {
            preSelectedLoanProductIdInput.value = initialSelectedProductId;
            // Clear localStorage item once used to prevent unintended pre-selection on next visit
            localStorage.removeItem('selectedProductId'); 
        }

        async function fetchLoanProducts(propertyId) {
            loanProductsContainer.innerHTML = `<div class="col-12"><div class="alert alert-info text-center">กำลังโหลดแพ็กเกจสินเชื่อ...</div></div>`;
            try {
                // สมมติว่ามี API endpoint ใหม่ที่ /api/loan_products_by_property/<property_id>/
                // ซึ่งส่ง JSON response ที่มีโครงสร้างคล้าย [{id: 1, bank_name: "ธนาคาร A", product_name: "รีไฟแนนซ์สุดคุ้ม", min_interest_rate: 3.0, max_interest_rate: 5.0, description: "...", suggested_loan_amount: ..., suggested_loan_term: ...}]
                // หาก API ของคุณมีโครงสร้างต่างออกไป ต้องปรับตามให้ถูกต้อง
                const apiUrl = `/api/loan_products_by_property/${propertyId}/`; // ต้องสร้าง API นี้ใน Django views.py
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                renderLoanProducts(data);
            } catch (error) {
                console.error('Error fetching loan products:', error);
                loanProductsContainer.innerHTML = `<div class="col-12"><div class="alert alert-danger text-center">ไม่สามารถโหลดแพ็กเกจสินเชื่อได้: ${error.message}</div></div>`;
            }
        }

        function renderLoanProducts(loanProducts) {
            loanProductsContainer.innerHTML = ''; // Clear previous content
            if (loanProducts.length === 0) {
                loanProductsContainer.innerHTML = `<div class="col-12"><div class="alert alert-warning text-center">ไม่พบแพ็กเกจสินเชื่อสำหรับทรัพย์สินนี้</div></div>`;
                return;
            }

            loanProducts.forEach(product => {
                const isChecked = (product.id == preSelectedLoanProductIdInput.value); // Use loose comparison for string/number
                
                // Set suggested loan amount and term if pre-selected product matches
                if (isChecked && product.suggested_loan_amount && product.suggested_loan_term) {
                    loanAmountInput.value = product.suggested_loan_amount;
                    loanTermInput.value = product.suggested_loan_term;
                }

                loanProductsContainer.innerHTML += `
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body d-flex flex-column">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="selected_loan_product" id="loanProduct${product.id}" value="${product.id}" ${isChecked ? 'checked' : ''} required>
                                    <label class="form-check-label w-100" for="loanProduct${product.id}">
                                        <h5 class="card-title">${product.bank_name || 'ไม่ระบุธนาคาร'}</h5>
                                        <h6 class="card-subtitle mb-2 text-muted">${product.product_name || 'ไม่ระบุชื่อแพ็กเกจ'}</h6>
                                        <p class="card-text">
                                            อัตราดอกเบี้ย: ${product.min_interest_rate ? product.min_interest_rate + '%' : 'N/A'} - ${product.max_interest_rate ? product.max_interest_rate + '%' : 'N/A'}<br>
                                            ${product.description ? product.description.substring(0, 100) + '...' : ''}
                                        </p>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // Event listener for property selection
        if (propertySelect) {
            propertySelect.addEventListener('change', function() {
                const selectedPropertyId = this.value;
                if (selectedPropertyId) {
                    fetchLoanProducts(selectedPropertyId);
                } else {
                    loanProductsContainer.innerHTML = `<div class="col-12"><div class="alert alert-info text-center">โปรดเลือกทรัพย์สินก่อน เพื่อแสดงแพ็กเกจสินเชื่อที่เกี่ยวข้อง</div></div>`;
                }
            });

            // Initial load: If a property is already selected (e.g., after form submission with errors),
            // or if a pre-selected product ID exists, try to load products.
            const initialPropertyId = propertySelect.value;
            if (initialPropertyId) {
                fetchLoanProducts(initialPropertyId);
            } else if (preSelectedLoanProductIdInput.value) {
                // If there's a pre-selected product but no property is selected,
                // you might need a way to determine the associated property ID,
                // or prompt the user to select the property first.
                // For now, it will wait for property selection.
            }
        }
    });
</script>
{% endblock %}