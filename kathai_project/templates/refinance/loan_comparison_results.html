
{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% load refinance_tags %}

{% block title %}ผลการเปรียบเทียบสินเชื่อรีไฟแนนซ์ - คัดให้{% endblock %}

{% block content %}
<div class="container py-4">

  <!-- Header -->
  <div class="comparison-header shadow-sm">
    <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between">
      <div class="mb-3 mb-md-0">
        <h1 class="title mb-1">ผลการเปรียบเทียบสินเชื่อรีไฟแนนซ์</h1>
        <p class="subtitle">เรียงลำดับข้อเสนอสินเชื่อที่เหมาะกับเงื่อนไขของคุณ</p>
      </div>
      <div class="mini-stats d-flex flex-wrap gap-3">
        <div class="mini-stat">
          <div class="mini-label"><i class="bi bi-bank"></i> ข้อเสนอที่พบ</div>
          <div class="mini-value text-primary">{{ total_products_found|default:0 }}</div>
        </div>
        <div class="mini-stat">
          <div class="mini-label" data-bs-toggle="tooltip" title="LTV (Loan-to-Value) คือ อัตราส่วนมูลค่าสินเชื่อต่อมูลค่าหลักประกัน">
            <i class="bi bi-currency-dollar"></i> LTV
          </div>
          <div class="mini-value {% if ltv_ratio > 80 %}text-danger{% else %}text-success{% endif %}">
            {{ ltv_ratio|floatformat:2 }}%
          </div>
        </div>
        <div class="mini-stat">
          <div class="mini-label" data-bs-toggle="tooltip" title="DSR (Debt Service Ratio) คือ อัตราส่วนภาระหนี้ต่อรายได้">
            <i class="bi bi-person-check"></i> DSR
          </div>
          <div class="mini-value {% if dsr_ratio > 70 %}text-danger{% else %}text-success{% endif %}">
            {{ dsr_ratio|floatformat:2 }}%
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- ข้อมูลที่กรอก -->
  <div class="card card-ghost mb-4">
    <div class="card-body p-3 p-md-4">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 gap-2">
        <h5 class="section-title mb-0"><i class="bi bi-info-circle me-2"></i>ข้อมูลที่คุณกรอก</h5>
        <button type="button" class="btn btn-sm btn-outline-secondary align-self-end align-self-md-center" 
                data-bs-toggle="modal" 
                data-bs-target="#editInputDataModal">
          <span class="d-none d-sm-inline">แก้ไขข้อมูล</span>
          <span class="d-sm-none">แก้ไข</span>
          <i class="bi bi-pencil-square ms-1"></i>
        </button>
      </div>
      <div class="row g-3 g-md-4">
        <div class="col-12 col-md-6">
          <div class="summary-block">
            <div class="block-title">ข้อมูลทรัพย์สิน</div>
            <div class="item"><span>ราคาทรัพย์สิน</span><strong>{{ property_price|intcomma }} บาท</strong></div>
            <div class="item"><span>ยอดหนี้คงเหลือ</span><strong>{{ current_loan_balance|intcomma }} บาท</strong></div>
            <div class="item"><span>ประเภททรัพย์สิน</span><strong>{{ user_property_type }}</strong></div>
            <div class="item"><span>จังหวัด</span><strong>{{ user_province }}</strong></div>
          </div>
        </div>
        <div class="col-12 col-md-6">
          <div class="summary-block">
            <div class="block-title">ข้อมูลผู้กู้</div>
            <div class="item"><span>อาชีพ</span><strong>{{ user_occupation }}</strong></div>
            <div class="item"><span>รายได้สุทธิ</span><strong>{{ monthly_income|intcomma }} บาท</strong></div>
            <div class="item"><span>ธนาคารปัจจุบัน</span><strong>{{ user_current_bank }}</strong></div>
            <div class="item"><span>ระยะเวลาผ่อนคงเหลือ</span><strong>{{ user_remaining_years }} ปี</strong></div>
            <div class="item"><span>ต้องการเงินกู้เพิ่ม</span><strong>{{ user_need_extra_loan }}</strong></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% if not has_results %}
  <div class="card card-ghost">
    <div class="card-body text-center py-5">
      <p class="lead text-muted"><i class="bi bi-exclamation-circle me-2"></i>ไม่พบข้อเสนอสินเชื่อที่ตรงกับเงื่อนไขของคุณ</p>
      <a href="{% url 'refinance:loan_comparison_wizard' %}" class="btn btn-warning mt-2">ลองกรอกข้อมูลใหม่</a>
    </div>
  </div>
  {% endif %}

  <!-- ฟอร์มสำหรับเปรียบเทียบ -->
  <form id="compareForm" action="{% url 'refinance:loan_summary_comparison' %}" method="post">
    {% csrf_token %}

    <!-- ปุ่มด้านบน -->
    <div class="text-center mb-3">
      {% if user.is_authenticated %} 
      <button type="submit" class="btn btn-primary btn-lg px-3 px-md-4" id="compareButtonTop" disabled> 
        <i class="bi bi-columns-gap me-2"></i> 
        <span class="d-none d-sm-inline">เปรียบเทียบที่เลือก</span>
        <span class="d-sm-none">เปรียบเทียบ</span>
        (<span class="selected-count">0</span>) 
      </button> 
      {% else %} 
      <a href="{% url 'accounts:register' %}" class="btn btn-primary btn-lg px-3 px-md-4 d-inline-flex align-items-center justify-content-center"> 
        <i class="bi bi-columns-gap me-2"></i> 
        <span class="d-none d-sm-inline">เปรียบเทียบที่เลือก</span>
        <span class="d-sm-none">เปรียบเทียบ</span>
        (<span class="selected-count">0</span>) 
      </a> 
      {% endif %}
      <small class="text-muted d-block mt-1">
        เลือก 2–5 รายการเพื่อเปรียบเทียบ
        {% if not user.is_authenticated %} 
        <br class="d-sm-none">
        <span class="text-danger d-inline-block mt-1">
          <i class="bi bi-lock-fill me-1"></i>เข้าสู่ระบบเพื่อใช้งาน
        </span>
        {% endif %}
      </small>
    </div>

    <div class="row g-3 g-md-4">
      {% if comparison_data %}
        {% for item in comparison_data %}
        <div class="col-12 col-md-6 col-lg-4">
          <div class="compare-card h-100">
            <div class="compare-card__head">
              <div class="d-flex align-items-center justify-content-between">
                <div class="bank-name">
                  {% if user.is_authenticated %}{{ item.bank_name }}{% else %}ธนาคาร XXXXXX{% endif %}
                </div>
                <div class="form-check form-switch">
                  <input class="form-check-input compare-checkbox"
                         type="checkbox"
                         name="selected_products"
                         value="{{ item.product.id }}"
                         id="checkbox-{{ item.product.id }}"
                         {% if not user.is_authenticated %}disabled data-bs-toggle="tooltip" data-bs-placement="top" title="เข้าสู่ระบบเพื่อเปรียบเทียบ"{% endif %}>
                </div>
              </div>
              <div class="product-name text-primary">
                {% if user.is_authenticated %}
                  {{ item.product_name }}
                {% else %}
                  xxxxx
                {% endif %}
              </div>
            </div>

            <div class="compare-card__body">
              <!-- ไฮไลต์ตัวเลขสำคัญ -->
              <div class="pill-stats">
                <div class="pill">
                  <div class="pill-label">ผ่อน/เดือน</div>
                  <div class="pill-value text-primary">
                    <span class="d-block d-sm-inline">{{ item.monthly_payment|intcomma }}</span>
                    <small class="d-block d-sm-inline">บาท</small>
                  </div>
                </div>
                <div class="pill">
                  <div class="pill-label">ดอกเฉลี่ย 3 ปี</div>
                  <div class="pill-value">{{ item.avg_3_year_rate|default:"-" }}<small>%</small></div>
                </div>
                <div class="pill">
                  <div class="pill-label">ค่าธรรมเนียมรวม</div>
                  <div class="pill-value">
                    <span class="d-block d-sm-inline">{{ item.total_fees|intcomma|default:"-" }}</span>
                    <small class="d-block d-sm-inline">บาท</small>
                  </div>
                </div>
              </div>

              <!-- รายละเอียดหลัก -->
              <ul class="kv-list mt-3">
                {% if user.is_authenticated %}
                  <li><i class="bi bi-percent"></i> <span class="kv-label">อัตราดอกเบี้ยเฉลี่ย 3 ปีแรก</span> <strong>{{ item.avg_3_year_rate }}%</strong></li>
                  <li><i class="bi bi-graph-up"></i> <span class="kv-label">ดอกเบี้ยตลอดสัญญา</span> <strong>{{ item.total_interest|intcomma }}</strong> บาท</li>
                  <li><i class="bi bi-tags"></i> <span class="kv-label">ค่าธรรมเนียมรวม</span> <strong>{{ item.total_fees|intcomma }}</strong> บาท</li>
                  <li><i class="bi bi-wallet2"></i> <span class="kv-label">ประหยัดต่อเดือน</span>
                    <strong class="{% if input_data.current_monthly_payment and item.monthly_payment < input_data.current_monthly_payment %}text-success{% endif %}">
                      {% if input_data.current_monthly_payment and item.monthly_payment < input_data.current_monthly_payment %}
                        {{ input_data.current_monthly_payment|sub:item.monthly_payment|intcomma }} บาท
                      {% else %}
                        0 บาท
                      {% endif %}
                    </strong>
                  </li>
                {% else %}
                  <li class="text-muted"><i class="bi bi-percent"></i> <span class="kv-label">อัตราดอกเบี้ยเฉลี่ย 3 ปีแรก</span> <strong>โปรดเข้าสู่ระบบ</strong></li>
                  <li class="text-muted"><i class="bi bi-graph-up"></i> <span class="kv-label">ดอกเบี้ยตลอดสัญญา</span> <strong>โปรดเข้าสู่ระบบ</strong></li>
                  <li class="text-muted"><i class="bi bi-tags"></i> <span class="kv-label">ค่าธรรมเนียมรวม</span> <strong>โปรดเข้าสู่ระบบ</strong></li>
                  <li class="text-muted"><i class="bi bi-wallet2"></i> <span class="kv-label">ประหยัดต่อเดือน</span> <strong>โปรดเข้าสู่ระบบ</strong></li>
                {% endif %}
                <li><i class="bi bi-star"></i> <span class="kv-label">โปรโมชั่น</span>
                  <span class="text-info">
                    {% if user.is_authenticated %}
                      {{ item.promotion_title|default:"ไม่มีโปรโมชั่นพิเศษ" }}
                    {% else %}
                      xxxxx
                    {% endif %}
                  </span>
                </li>
                <li><i class="bi bi-clock-history"></i> <span class="kv-label">ระยะเวลาสูงสุด</span> <strong>{{ item.max_term }}</strong> ปี</li>
              </ul>
            </div>

            <div class="compare-card__foot">
              {% if user.is_authenticated %}
                <button type="button" class="btn btn-outline-secondary btn-sm flex-fill" data-bs-toggle="modal" data-bs-target="#productDetailModal-{{ forloop.counter }}">
                  <i class="bi bi-search me-1"></i> <span class="d-none d-sm-inline">รายละเอียด</span><span class="d-sm-none">รายละเอียด</span>
                </button>
                <a href="{% url 'refinance:apply_loan' item.product.id %}" class="btn btn-kathai btn-sm flex-fill ms-2">
                  <i class="bi bi-send-fill me-1"></i> <span class="d-none d-sm-inline">สมัครเลย</span><span class="d-sm-none">สมัคร</span>
                </a>
              {% else %}
                <a href="{% url 'accounts:login' %}?next={{ request.path }}" class="btn btn-outline-primary btn-sm w-100">
                  <i class="bi bi-box-arrow-in-right me-1"></i> เข้าสู่ระบบ
                </a>
              {% endif %}
            </div>
          </div>
        </div>

        {% endfor %}
      {% else %}
        <div class="col-12">
          <div class="card card-ghost">
            <div class="card-body text-center py-5">
              <p class="lead text-muted">ไม่พบข้อเสนอสินเชื่อที่ตรงกับเงื่อนไขของคุณ</p>
              <a href="{% url 'refinance:loan_comparison_wizard' %}" class="btn btn-warning mt-2">ลองกรอกข้อมูลใหม่</a>
            </div>
          </div>
        </div>
      {% endif %}
    </div>

    <!-- Sticky compare dock (ลอยด้านล่าง) -->
    <div id="compareDock" class="compare-dock shadow-lg">
      <div class="dock-content">
        <div class="dock-text">
          <i class="bi bi-columns-gap me-2"></i> เลือกไว้ <strong class="selected-count">0</strong> รายการ
          <span class="text-muted ms-2 d-none d-sm-inline">เลือก 2–5 รายการเพื่อเปรียบเทียบ</span>
        </div>
        <div class="dock-actions">
          <button type="submit" class="btn btn-primary" id="compareButtonDock" disabled>
            <span class="d-none d-sm-inline">เปรียบเทียบตอนนี้</span>
            <span class="d-sm-none">เปรียบเทียบ</span>
          </button>
        </div>
      </div>
    </div>
  </form>

  <!-- Modal -->
  <div class="modal fade" id="editInputDataModal" tabindex="-1" aria-labelledby="editInputDataModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-warning text-white">
          <h5 class="modal-title" id="editInputDataModalLabel">
            <i class="bi bi-pencil-square me-2"></i> แก้ไขข้อมูลที่กรอก
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="editFormContainer">
            <div class="text-center p-3">
              <div class="spinner-border" role="status"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const isAuthenticated = {{ user.is_authenticated|yesno:"true,false" }};
  const checkboxes = document.querySelectorAll('.compare-checkbox');
  const countEls = document.querySelectorAll('.selected-count');
  const btnTop = document.getElementById('compareButtonTop');
  const btnDock = document.getElementById('compareButtonDock');

  function updateState() {
    const checkedCount = document.querySelectorAll('.compare-checkbox:checked').length;
    countEls.forEach(el => el.textContent = checkedCount);

    const enable = (checkedCount >= 2 && checkedCount <= 5 && isAuthenticated);
    [btnTop, btnDock].forEach(btn => { if (btn) btn.disabled = !enable; });

    // แสดง/ซ่อน dock ตามการเลือก
    const dock = document.getElementById('compareDock');
    if (dock) {
      dock.classList.toggle('show', checkedCount > 0);
    }
  }

  checkboxes.forEach(chk => chk.addEventListener('change', updateState));
  updateState();

  // Bootstrap tooltip (สำหรับปุ่ม/สวิตช์ที่ disable)
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
  tooltipTriggerList.map(el => new bootstrap.Tooltip(el));
});

document.addEventListener("DOMContentLoaded", function() {
    const editModal = document.getElementById("editInputDataModal");
    const formContainer = document.getElementById("editFormContainer");

    function getCookie(name) {
        let cookieValue = null;
        document.cookie.split(';').forEach(cookie => {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            }
        });
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    editModal.addEventListener("show.bs.modal", function () {
        formContainer.innerHTML = '<div class="text-center p-3"><div class="spinner-border" role="status"></div></div>';

        fetch("{% url 'refinance:loan_comparison_edit' %}", {
            method: 'GET',
            headers: { "X-Requested-With": "XMLHttpRequest", "X-CSRFToken": csrftoken }
        })
        .then(res => res.json())
        .then(data => {
            formContainer.innerHTML = data.form_html || "<div class='alert alert-danger'>เกิดข้อผิดพลาด</div>";

            // bind submit ใหม่หลัง load form
            const form = formContainer.querySelector("form");
            form.addEventListener("submit", function(e){
                e.preventDefault();
                const formData = new FormData(form);

                fetch(form.action, {
                    method: "POST",
                    body: formData,
                    headers: { "X-Requested-With": "XMLHttpRequest", "X-CSRFToken": csrftoken }
                })
                .then(res => res.json())
                .then(data => {
                    if(data.success){
                        bootstrap.Modal.getInstance(editModal).hide();
                        setTimeout(() => {
                            if(data.redirect_url){
                                window.location.href = data.redirect_url;
                            } else {
                                window.location.reload();
                            }
                        }, 300);
                    } else {
                        formContainer.innerHTML = data.errors_html || "<div class='alert alert-danger'>เกิดข้อผิดพลาด</div>";
                        // bind submit ใหม่อีกครั้ง
                        formContainer.querySelector("form").addEventListener("submit", arguments.callee);
                    }
                })
                .catch(err => console.error(err));
            });
        })
        .catch(err => {
            console.error(err);
            formContainer.innerHTML = '<div class="alert alert-danger">เกิดข้อผิดพลาดในการโหลดฟอร์ม</div>';
        });
    });
});

class BulletproofCurrencyFormatter {
  constructor(options = {}) {
    this.processedElements = new WeakSet();
    this.processedForms = new WeakSet();
    this.retryAttempts = options.retryAttempts || 3;
    this.retryDelay = options.retryDelay || 100;
    this.debug = options.debug || false;
    
    this.selector = [
      "input[data-type='currency']",
      "input.currency",
      "input[name='property_price']",
      "input[name='current_loan_balance']",
      "input[name='monthly_income']",
      "input[name='current_monthly_payment']",
    ].join(',');

    // Set up mutation observer for dynamic content
    this.setupMutationObserver();
    
    // Set up periodic check as fallback
    this.setupPeriodicCheck();
  }

  log(...args) {
    if (this.debug) {
      console.log('[CurrencyFormatter]', ...args);
    }
  }

  formatValue(raw) {
    try {
      const s = (raw ?? '').toString().replace(/,/g, '').trim();
      if (s === '' || isNaN(s)) return '';
      const num = Number(s);
      if (!isFinite(num)) return '';
      return num.toLocaleString('en-US');
    } catch (e) {
      this.log('Error formatting value:', raw, e);
      return raw; // Return original if formatting fails
    }
  }

  attachToElement(input, attempt = 1) {
    try {
      if (!input || !input.tagName || this.processedElements.has(input)) {
        return;
      }

      // Verify element is still in DOM
      if (!document.contains(input)) {
        this.log('Element not in DOM, skipping:', input);
        return;
      }

      this.processedElements.add(input);
      this.log('Processing element:', input.name || input.id || input.className);

      // Format existing value with retry
      if (input.value) {
        const formatted = this.formatValue(input.value);
        if (formatted !== input.value) {
          input.value = formatted;
          this.log('Formatted initial value:', input.value);
        }
      }

      // Create handlers with error protection
      const inputHandler = (e) => {
        try {
          const v = e.target.value.replace(/,/g, '');
          const formatted = (v && !isNaN(v)) ? Number(v).toLocaleString('en-US') : '';
          e.target.value = formatted;
        } catch (error) {
          this.log('Error in input handler:', error);
        }
      };

      const blurHandler = (e) => {
        try {
          const v = e.target.value.replace(/,/g, '');
          const formatted = (v && !isNaN(v)) ? Number(v).toLocaleString('en-US') : '';
          e.target.value = formatted;
        } catch (error) {
          this.log('Error in blur handler:', error);
        }
      };
      
      input.addEventListener('input', inputHandler);
      input.addEventListener('blur', blurHandler);

      // Handle form submission - remove commas before submit
      const form = input.form || input.closest('form');
      if (form && !this.processedForms.has(form)) {
        this.processedForms.add(form);
        
        // Add submit event listener with high priority (capture phase)
        form.addEventListener('submit', (e) => {
          this.log('Form submitting, removing commas...');
          try {
            const currencyInputs = form.querySelectorAll(this.selector);
            currencyInputs.forEach(el => {
              if (el.value && el.value.includes(',')) {
                const originalValue = el.value;
                el.value = el.value.replace(/,/g, '');
                this.log(`Cleaned: ${originalValue} → ${el.value}`);
              }
            });
          } catch (error) {
            this.log('Error cleaning values before submit:', error);
          }
        }, true); // Use capture phase for higher priority
        
        this.log('Added form submit handler to:', form.id || 'unnamed form');
      }

    } catch (error) {
      this.log('Error attaching to element:', error);
      
      // Retry with delay if attempts remaining
      if (attempt < this.retryAttempts) {
        setTimeout(() => {
          this.attachToElement(input, attempt + 1);
        }, this.retryDelay * attempt);
      }
    }
  }

  attachToContainer(container, attempt = 1) {
    try {
      if (!container) {
        this.log('Container is null/undefined');
        return;
      }
      
      this.log('Scanning container for currency inputs:', container.tagName, container.id);
      
      const inputs = container.querySelectorAll(this.selector);
      this.log('Found inputs:', inputs.length);
      
      if (inputs.length === 0 && attempt < this.retryAttempts) {
        // Retry if no inputs found (content might still be loading)
        setTimeout(() => {
          this.attachToContainer(container, attempt + 1);
        }, this.retryDelay * attempt);
        return;
      }
      
      inputs.forEach(input => this.attachToElement(input));
      
    } catch (error) {
      this.log('Error in attachToContainer:', error);
      
      if (attempt < this.retryAttempts) {
        setTimeout(() => {
          this.attachToContainer(container, attempt + 1);
        }, this.retryDelay * attempt);
      }
    }
  }

  // Watch for dynamically added content
  setupMutationObserver() {
    if (typeof MutationObserver === 'undefined') {
      this.log('MutationObserver not supported');
      return;
    }

    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        mutation.addedNodes.forEach((node) => {
          if (node.nodeType === Node.ELEMENT_NODE) {
            // Check if the node itself matches
            if (node.matches && node.matches(this.selector)) {
              setTimeout(() => this.attachToElement(node), 10);
            }
            // Check for matching descendants
            if (node.querySelectorAll) {
              const inputs = node.querySelectorAll(this.selector);
              inputs.forEach(input => {
                setTimeout(() => this.attachToElement(input), 10);
              });
            }
          }
        });
      });
    });

    observer.observe(document.body, {
      childList: true,
      subtree: true
    });

    this.log('MutationObserver set up');
  }

  // Fallback periodic check
  setupPeriodicCheck() {
    setInterval(() => {
      try {
        const unprocessedInputs = Array.from(document.querySelectorAll(this.selector))
          .filter(input => !this.processedElements.has(input));
        
        if (unprocessedInputs.length > 0) {
          this.log('Found unprocessed inputs:', unprocessedInputs.length);
          unprocessedInputs.forEach(input => this.attachToElement(input));
        }
      } catch (error) {
        this.log('Error in periodic check:', error);
      }
    }, 2000); // Check every 2 seconds
  }

  // Manual reinitialization method
  reinitialize() {
    this.log('Reinitializing formatter');
    this.attachToContainer(document);
  }

  // Clean up method
  destroy() {
    this.processedElements = new WeakSet();
    this.processedForms = new WeakSet();
  }

  // Verify all inputs are formatted
  verifyFormatting() {
    const inputs = document.querySelectorAll(this.selector);
    const unformatted = Array.from(inputs).filter(input => {
      if (!input.value) return false;
      const hasCommas = input.value.includes(',');
      const isNumeric = !isNaN(input.value.replace(/,/g, ''));
      return !hasCommas && isNumeric && input.value.replace(/,/g, '') !== '';
    });
    
    this.log('Verification - Total inputs:', inputs.length, 'Unformatted:', unformatted.length);
    return unformatted;
  }
}

// Usage with maximum reliability:
const currencyFormatter = new BulletproofCurrencyFormatter({
  debug: true, // Enable for debugging
  retryAttempts: 5,
  retryDelay: 200
});

// Multiple initialization strategies
document.addEventListener('DOMContentLoaded', () => {
  currencyFormatter.attachToContainer(document);
});

// Fallback for cases where DOMContentLoaded already fired
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    currencyFormatter.attachToContainer(document);
  });
} else {
  currencyFormatter.attachToContainer(document);
}

// Additional fallback
window.addEventListener('load', () => {
  setTimeout(() => {
    currencyFormatter.attachToContainer(document);
  }, 100);
});

// For modal content - enhanced submit handling
function wireEditForm(container, csrftoken, editModal) {
  const form = container.querySelector('form');
  if (!form) return;

  // Apply currency formatting with multiple strategies
  currencyFormatter.attachToContainer(container);
  
  // Additional verification after a short delay
  setTimeout(() => {
    const unformatted = currencyFormatter.verifyFormatting();
    if (unformatted.length > 0) {
      console.warn('Some inputs remain unformatted, retrying...');
      currencyFormatter.reinitialize();
    }
  }, 500);

  // Enhanced form submission with comma removal guarantee
  form.addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Force remove commas before creating FormData
    const currencyInputs = form.querySelectorAll(currencyFormatter.selector);
    currencyInputs.forEach(input => {
      if (input.value && input.value.includes(',')) {
        console.log(`Removing commas from ${input.name}: ${input.value} → ${input.value.replace(/,/g, '')}`);
        input.value = input.value.replace(/,/g, '');
      }
    });
    
    const formData = new FormData(form);
    
    // Double-check FormData values (for debugging)
    for (let [key, value] of formData.entries()) {
      if (typeof value === 'string' && value.includes(',')) {
        console.warn(`Found comma in FormData for ${key}: ${value}`);
        formData.set(key, value.replace(/,/g, ''));
      }
    }

    fetch(form.action, {
      method: 'POST',
      body: formData,
      headers: { 
        'X-Requested-With': 'XMLHttpRequest', 
        'X-CSRFToken': csrftoken 
      }
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        const modalInstance = bootstrap.Modal.getInstance(editModal);
        if (modalInstance) modalInstance.hide();
        setTimeout(() => window.location.reload(), 300);
      } else {
        container.innerHTML = data.errors_html || "<div class='alert alert-danger'>เกิดข้อผิดพลาด</div>";
        // Re-wire the new form
        wireEditForm(container, csrftoken, editModal);
      }
    })
    .catch(err => {
      console.error('Form submission error:', err);
    });
  });
}

// Expose global method for manual fixing if needed
window.fixCurrencyFormatting = () => {
  currencyFormatter.reinitialize();
  setTimeout(() => {
    const unformatted = currencyFormatter.verifyFormatting();
    if (unformatted.length > 0) {
      console.warn('Manual fix incomplete. Unformatted inputs:', unformatted);
    } else {
      console.log('All currency inputs are properly formatted');
    }
  }, 100);
};

</script>
{% endblock %}

{% block extra_css %}
<style>
  :root{
    --surface:#ffffff;
    --bg:#f5f6f8;
    --text:#2b2f33;
    --muted:#6c757d;
    --primary:#0d6efd;
    --gold:#a87f3b;
    --border:#e6e8eb;
    --soft:#f8f9fa;
    --success:#198754;
    --danger:#dc3545;
    --shadow:0 8px 24px rgba(0,0,0,.08);
  }

  body{background:var(--bg);}
  .card-ghost{background:var(--surface); border:1px solid var(--border); border-radius:14px;}
  .section-title{color:var(--text); font-weight:700;}
  .title{font-weight:800; color:var(--text);}
  .subtitle{color:var(--muted); margin:0;}

  .comparison-header{
    background:var(--surface);
    border:1px solid var(--border);
    border-radius:16px;
    padding:20px 24px;
    margin-bottom:18px;
  }
  .mini-stats .mini-stat{min-width:120px; text-align:center;}
  .mini-label{color:var(--muted); font-size:.85rem;}
  .mini-value{font-weight:800; font-size:1.3rem;}

  .summary-block{background:var(--soft); border:1px dashed var(--border); border-radius:12px; padding:14px;}
  .summary-block .block-title{color:var(--text); font-weight:600; margin-bottom:8px;}
  .summary-block .item{display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed var(--border);}
  .summary-block .item:last-child{border-bottom:none;}
  .summary-block .item span{color:var(--muted);}
  .summary-block .item strong{color:var(--text);}

  .compare-card{
    background:var(--surface);
    border:1px solid var(--border);
    border-radius:16px;
    box-shadow:0 6px 16px rgba(0,0,0,.05);
    display:flex; flex-direction:column;
    transition:transform .15s ease, box-shadow .15s ease;
  }
  .compare-card:hover{ transform:translateY(-3px); box-shadow:var(--shadow); }

  .compare-card__head{ padding:16px 16px 8px 16px; border-bottom:1px solid var(--border);}
  .bank-name{ font-weight:700; color:var(--text); }
  .product-name{ font-weight:600; margin-top:6px; }

  .compare-card__body{ padding:14px 16px; }
  .pill-stats{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
  .pill{ background:var(--soft); border:1px solid var(--border); border-radius:12px; padding:8px 10px; text-align:center; }
  .pill-label{ color:var(--muted); font-size:.8rem; }
  .pill-value{ font-weight:800; font-size:1.05rem; color:var(--text); }
  .pill-value small{ font-weight:600; color:var(--muted); }

  .kv-list{ list-style:none; padding-left:0; margin:0; }
  .kv-list li{ display:flex; align-items:center; gap:8px; padding:6px 0; color:var(--text);}
  .kv-list i{ color:#6c757d; }

  .compare-card__foot{ padding:12px 16px; border-top:1px solid var(--border); display:flex; justify-content:space-between; gap:8px; }

  .btn-kathai{ background:var(--gold); color:#fff; border:none; }
  .btn-kathai:hover{ background:#8c6a2e; color:#fff; }

  /* Sticky compare dock */
  .compare-dock{
    position:fixed; left:0; right:0; bottom:-120px;
    background:rgba(255,255,255,.98);
    border-top:1px solid var(--border);
    transition:bottom .2s ease;
    z-index:1040;
  }
  .compare-dock.show{ bottom:0; }
  .compare-dock .dock-content{
    max-width:1200px; margin:0 auto; padding:10px 16px;
    display:flex; align-items:center; justify-content:space-between; gap:12px;
  }
  .compare-dock .dock-text{ color:var(--text); }
  .compare-dock .dock-actions .btn{ min-width:180px; }

  /* Responsive */
  @media (max-width: 991.98px){
    .pill-stats{ grid-template-columns:1fr 1fr; }
  }
  @media (max-width: 575.98px){
    .pill-stats{ grid-template-columns:1fr; }
    .mini-stats{ width:100%; justify-content:space-between; }
  }
</style>
{% endblock %}
